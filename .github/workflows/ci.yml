name: CI

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master

jobs:
  build-rust:
    name: Rust Build & Tests (Ubuntu)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: nightly
          override: true
          profile: minimal

      - name: rustfmt check
        run: cargo fmt --all -- --check

      - name: clippy
        run: cargo clippy --all-targets --all-features -- -D warnings -D clippy::unwrap_used

      - name: Scan for unwrap/expect in production src
        run: |
          echo "Scanning for unwrap()/expect() in production source directories"
          matches=$(git grep -n --line-number -E "(\.unwrap\(|\.expect\()" -- 'crates/**/src/**' 'core/src/**' || true)
          # Exclude test directories from matches
          filtered=$(echo "$matches" | grep -v '/tests/' || true)
          if [ -n "$filtered" ]; then
            echo "Found forbidden unwrap()/expect() usage in production code:"; echo "$filtered"; exit 1
          fi

      - name: Run cargo tests
        run: cargo test --workspace --all-features --verbose

      - name: Run coverage (cargo-tarpaulin) and upload results
        run: |
          cargo install cargo-tarpaulin --version 0.25.0 || true
          cargo tarpaulin --out Xml --all -- -q || true
        continue-on-error: true

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-xml
          path: ./tarpaulin-report.xml

      - name: Check coverage threshold (fail if < 70%)
        if: always()
        run: |
          if [ ! -f ./tarpaulin-report.xml ]; then echo "Coverage report not found, skipping threshold check"; exit 0; fi
          python - <<'PY'
import xml.etree.ElementTree as ET
root = ET.parse('tarpaulin-report.xml').getroot()
# Cobertura-like: check line-rate attribute if present
rate = None
if 'line-rate' in root.attrib:
    rate = float(root.attrib['line-rate'])
else:
    # fallback: try to find coverage percent in packages or sources
    for elem in root.iter():
        if 'line-rate' in elem.attrib:
            rate = float(elem.attrib['line-rate'])
            break
if rate is None:
    print('Could not detect coverage rate, skipping')
    raise SystemExit(0)
pct = rate * 100
print(f'Coverage: {pct:.2f}%')
if pct < 70.0:
    print('Coverage below threshold (70%), failing job')
    raise SystemExit(2)
PY

  windows-build:
    name: Windows Build (C++ Core + WinUI + Rust)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Qt/VS/CMake (preinstalled on windows-latest)
        run: cmake --version

      - name: Build Core (CMake)
        working-directory: ${{ runner.workspace }}
        run: |
          cmake -S core -B core/build -DCMAKE_BUILD_TYPE=Release
          cmake --build core/build --config Release

      - name: Run C++ Core Tests (CTest)
        working-directory: ${{ runner.workspace }}/core/build
        run: |
          echo "Running C++ tests with CTest..."
          # Output JUnit XML for CI parsing and upload
          ctest --output-on-failure -C Release --output-junit ctest-results.xml || true

      - name: Upload CTest results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ctest-results
          path: core/build/ctest-results.xml

      - name: Upload Core Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: core-artifacts
          path: core/build/bin/**

      - name: Build WinUI Shell (.NET)
        run: |
          dotnet --version
          dotnet build ui/native/VerseguY.UI/VerseguY.UI.csproj -c Release

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: nightly
          override: true
          profile: minimal

      - name: Run cargo fmt
        run: cargo fmt --all -- --check

      - name: Run cargo tests
        run: cargo test --workspace --verbose

      - name: Run master-server tests (Windows)
        run: |
          cargo test -p master_server --verbose 2>&1 | Tee-Object -FilePath master_server_tests.log
        shell: pwsh

      - name: Upload master-server test logs (Windows)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: master-server-tests-windows
          path: master_server_tests.log

  master-server-tests:
    name: Master Server Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: nightly
          override: true
          profile: minimal

      - name: Run master-server tests
        run: |
          cargo test -p master_server --verbose 2>&1 | tee master_server_tests.log

      - name: Upload master-server test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: master-server-tests-logs
          path: master_server_tests.log

  admin-cli-smoke:
    name: Admin CLI smoke test
    runs-on: ubuntu-latest
    needs: master-server-tests
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Build server and admin CLI
        run: |
          cargo build -p master_server --release --features run-server
          cargo build -p master_server --bin verseguy-admin --release

      - name: Prepare test DB and key
        run: |
          mkdir -p tmptest
          export MASTER_DB_PATH=tmptest/db
          export MASTER_KEY_FILE=tmptest/master.key
          export MASTER_ADMIN_TOKEN=testtoken
          export MASTER_LICENSE_SECRET=testsecret

      - name: Start master server
        run: |
          ./target/release/master_server &
          echo $! > master_server.pid

      - name: Wait for server
        run: |
          for i in {1..20}; do
            status=$(curl -s -o /dev/null -w "%{http_code}" "http://127.0.0.1:3000/plugins/search?q=") || status=000
            echo "Server status: $status"
            if [ "$status" = "200" ]; then
              break
            fi
            sleep 1
          done

      - name: Run admin CLI smoke tests
        run: |
          ./target/release/verseguy-admin --server http://127.0.0.1:3000 --token testtoken key-list > admin-key-list.log || true
          ./target/release/verseguy-admin --server http://127.0.0.1:3000 --token testtoken key-rotate > admin-key-rotate.log || true
          ./target/release/verseguy-admin --server http://127.0.0.1:3000 --token testtoken key-import --b64 "$(base64 -w0 tmptest/master.key)" > admin-key-import.log || true

      - name: Upload admin CLI logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: admin-cli-logs
          path: |
            admin-key-list.log
            admin-key-rotate.log
            admin-key-import.log

      - name: Kill master server
        if: always()
        run: |
          if [ -f master_server.pid ]; then
            kill $(cat master_server.pid) || true
          fi
  e2e-playwright:
    name: Playwright E2E (UI + Master Server)
    runs-on: ubuntu-latest
    needs: admin-cli-smoke
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install UI deps & Playwright browsers
        working-directory: ui/web
        run: |
          npm ci
          npx playwright install --with-deps

      - name: Build master-server
        run: |
          cargo build -p master_server --release --features run-server

      - name: Start master server
        env:
          MASTER_SERVER_PORT: 3001
          MASTER_DB_PATH: ./tmp/e2e_db
          MASTER_LICENSE_SECRET: e2e-secret
        run: |
          ./target/release/master_server &
          echo $! > master_server.pid

      - name: Wait for master server
        run: |
          for i in {1..30}; do
            status=$(curl -s -o /dev/null -w "%{http_code}" "http://127.0.0.1:3001/plugins/search?q=") || status=000
            echo "Server status: $status"
            if [ "$status" = "200" ]; then
              break
            fi
            sleep 1
          done

      - name: Start web dev server
        working-directory: ui/web
        run: |
          npm start &>/tmp/web.log &
          echo $! > web.pid

      - name: Wait for web UI
        run: |
          for i in {1..30}; do
            status=$(curl -s -o /dev/null -w "%{http_code}" "http://127.0.0.1:3000/") || status=000
            echo "Web status: $status"
            if [ "$status" = "200" ]; then
              break
            fi
            sleep 1
          done

      - name: Run Playwright tests
        env:
          PLAYWRIGHT_BASE_URL: http://127.0.0.1:3000
          PLAYWRIGHT_API_URL: http://127.0.0.1:3001
        working-directory: ui/web
        run: |
          npm run test:e2e --silent

      - name: Upload Playwright results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-results
          path: |
            ui/web/playwright-report
            ui/web/test-results
            ui/web/videos
            /tmp/web.log
            tmp/e2e_db

      - name: Kill servers
        if: always()
        run: |
          if [ -f master_server.pid ]; then kill $(cat master_server.pid) || true; fi
          if [ -f web.pid ]; then kill $(cat web.pid) || true; fi
  meta:
    name: Sanity
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Show project summary
        run: |
          echo "Workspace members:"; ls -1

